<link href='/css/bootstrap.min.css' rel='stylesheet' type="text/css" />

<h2> Topic </h2>
<div>
  <div>
    <h2> Partitions </h2>
    <table class="table">
      <thead>
        <tr>
          <th>Number</th>
          <th>Leader</th>
          <th>In sync replicas</th>
          <th>Start offset</th>
          <th>End Offset</th>
        </tr>
      </thead>
      <tbody id="partition-rows"></tbody>
    </table>
  </div>
  <div>
    <h3> Update topic </h3>
    <form id="update-topic" action="">
      <div class="form-group">
        <label for="partitions">Partitions</label>
        <input type="number" class="form-control" name="partition_count" value="10" step=1 min=0>
      </div>
      <div class="form-group">
        <label for="name">Replication factor</label>
        <input type="text" class="form-control" name="replication_factor" value="1" step="1" min="1">
      </div>
      <button type="submit" class="btn btn-default">Update</button>
    </form>
  </div>
  <div>
    <h3> Delete topic </h3>
    <form id="delete-topic" action="">
      <button type="submit" class="btn btn-danger">Delete</button>
    </form>
  </div>
</div>
<script id='tmpl-partitions' type='text/x-handlebars-template'>
  {{#partitions}}
    <tr>
      <td> {{number}} </td>
      <td> {{leader}} </td>
      <td> {{isr}} </td>
      <td>{{log_start_offset}}</td>
      <td>{{log_end_offset}}</td>
    < /tr >
  {{/partitions}}
</script>
<script src='/js/jquery-3.1.1.min.js' type="text/javascript" ></script>
<script src='/js/handlebars.min.js' type="text/javascript" ></script>
<script type="text/javascript">
  var topicName = document.location.pathname.replace("/topics/", "");
  document.title = "Topic: "+ topicName;
  var renderPartitions = function() {
    var $partitions = $('#partition-rows');
    var partitionsTmpl = Handlebars.compile($('#tmpl-partitions').html());
    var path = "/api/topics/"+ topicName;
    $.get(path, function(topic) {
      var l = Object.keys(topic.partitions).length;
      var res = [];
      Object.keys(topic.partitions).forEach(function(p) {
        $.get(path + "/" + p, function(partition) {
          res.push(partition)
          if (res.length == l) {
            res.sort(function(a, b) {
              return a.number - b.number
            })
            $partitions.html(partitionsTmpl({ partitions: res }));
          }
        })
      })
    })
  }
$('#update-topic').submit(function(evt) {
  evt.preventDefault();
  console.log($(this).serializeArray());
  $.ajax({
    url: "/api" + document.location.pathname,
    type: "PUT",
    data: $(this).serialize(),
    success: function(blk) {
      renderPartitions();
    }
  })
})
$('#delete-topic').submit(function(evt) {
  evt.preventDefault();
  console.log($(this).serializeArray());
  $.ajax({
    url: "/api" + document.location.pathname,
    type: "DELETE",
    success: function(blk) {
      document.location.pathname = "/"
    }
  })
})

  renderPartitions();
</script>
