<link href='/css/bootstrap.min.css' rel='stylesheet' type="text/css" />

<h1> User </h1>
<div>
  <div>
    <h2> Permissions </h2>
    <dl class="row" id="user-rows">
    </dl>
  </div>
  <div>
    <h3> Add permission </h2>
    <form id="add-permission">
      <div class="form-group">
        <label for="name">Username</label>
        <input type="text" disabled class="form-control" name="username" id="username">
      </div>
      <div class="form-group">
        <label for="resource">Resource name</label>
        <input type="text" class="form-control" name="resource" placeholder="Resource (eg Topic name or Consumer group name">
      </div>
      <div class="form-group">
        <label for="type">Type</label>
        <select class="form-control" name="type">
          <option value="Cluster"> Cluster </option>
          <option value="Topic"> Topic </option>
          <option value="Group"> Consumer Group</option>
        </select>
      </div>
      <div class="form-group">
        <label for="permission">Permission</label>
        <select class="form-control" name="permission">
          <option value="Read"> Read </option>
          <option value="Write"> Write </option>
          <option value="Read/Write"> Read/Write </option>
        </select>
      </div>
      <button type="submit" class="btn btn-default">Create</button>
    </form>
  </div>
  <div>
    <h3> Delete user </h3>
    <form id="delete-user" action="">
      <button type="submit" class="btn btn-danger">Delete</button>
    </form>
  </div>
</div>
<script id='tmpl-user' type='text/x-handlebars-template'>
    <dt class="col-sm-3"> Cluster </dt>
    <dd class="col-sm-9"> {{cluster}}
      <form class="delete-acl", action="/api/acls/Cluster/{{@key}}/{{../username}}">
        <button type="submit" class="btn btn-danger"> Delete </button>
      </form>
    </dd>
    <dt class="col-sm-12"> Topic permissions</dt>
    {{#each topics}}
    <dt class="col-sm-3"> {{@key}} </dt>
    <dd class="col-sm-9"> {{this}} </dd>
      <form class="delete-acl", action="/api/acls/Topic/{{@key}}/{{../username}}">
        <button type="submit" class="btn btn-danger"> Delete </button>
      </form>
    {{/each }}
    <dt class="col-sm-12"> Consumer group permissions</dt>
    {{#each groups}}
    <dt class="col-sm-3"> {{@key}} </dt>
    <dd class="col-sm-9">
      {{this}}
      <form class="delete-acl", action="/api/acls/Group/{{@key}}/{{../username}}">
        <button type="submit" class="btn btn-danger"> Delete </button>
      </form>
    </dd>
    {{/each }}
</script>
<script src='/js/jquery-3.1.1.min.js' type="text/javascript" ></script>
<script src='/js/handlebars.min.js' type="text/javascript" ></script>
<script type="text/javascript">
  var username = document.location.pathname.replace("/users/", "");
  document.title = "User: "+ username;
  $("#username").attr('value', username);
  var renderUser = function() {
    var $user = $('#user-rows');
    var userTmpl = Handlebars.compile($('#tmpl-user').html());
    var path = "/api/users/"+ username;
    $.get(path, function(user) {
       $user.html(userTmpl(user));
    })
  }
$('#add-permission').submit(function(evt) {
  evt.preventDefault();
  $.post("/api/acls", $(this).serialize(), function(clb) {
    renderUser();
  })
})
$('#delete-user').submit(function(evt) {
  evt.preventDefault();
  $.ajax({
    url: "/api" + document.location.pathname,
    type: "DELETE",
    success: function(blk) {
      document.location.pathname = "/"
    }
  })
})

$('#user-rows').on('submit', '.delete-acl', function(evt) {
  evt.preventDefault();
  $.ajax({
    url: $(this).attr("action"),
    type: "DELETE",
    success: function() {
      renderUser();
    }
  })
})

  renderUser();
</script>

