<link href='/css/bootstrap.min.css' rel='stylesheet' type="text/css" />
<h1> CloudKarafka's Apache Kafka Management Interface </h1>

<div>
  <h2> Brokers </h2>
  <table class="table">
    <thead>
      <tr>
        <th> Id </th>
        <th> Version </th>
        <th> Endpoints </th>
        <th> Uptime </th>
        <th> Messages in/s </th>
        <th> Bytes in/s </th>
        <th> Bytes out/s </th>
      </tr>
    </thead>
    <tbody id="broker-rows"> </tbody>
  </table>
</div>

<script id='tmpl-brokers' type='text/x-handlebars-template'>
{{#brokers}}
    <tr>
      <td> <a href="/brokers/{{id}}" > {{id}} </a> </td>
      <td> {{kafka_version}}</td>
      <td> {{endpoints}} </td>
      <td> {{uptime}} </td>
      <td> {{messages_in_per_sec}} </td>
      <td> {{bytes_in_per_sec}} </td>
      <td> {{bytes_out_per_sec}} </td>
    </tr>
  {{/brokers}}
</script>

<script id='tmpl-no-brokers' type='text/x-handlebars-template'>
  <tr> <td colspan="4"> No online brokers </td> </tr>
</script>

<div>
  <div>
    <h2> Topics </h2>
    <table class=table>
      <thead>
        <tr>
          <th> Name </th>
          <th> Partitions </th>
          <th> ReplicationFactor </th>
          <th> Messages in/s </th>
          <th> Bytes in/s </th>
          <th> Bytes out/s </th>
        </tr>
      </thead>
      <tbody id="topic-rows"> </tbody>
    </table>
  </div>
  <div>
    <h3> Add topic </h2>
    <form id="add-topic">
      <div class="form-group">
        <label for="name">Name</label>
        <input type="text" class="form-control" name="name" placeholder="Topic name">
      </div>
      <div class="form-group">
        <label for="partitions">Partitions</label>
        <input type="number" class="form-control" name="partition_count" value="10" step=1 min=0>
      </div>
      <div class="form-group">
        <label for="name">Replication factor</label>
        <input type="text" class="form-control" name="replication_factor" value="1" step="1" min="1">
      </div>
      <button type="submit" class="btn btn-default">Create</button>
    </form>
  </div>
</div>

<script id='tmpl-no-topics' type='text/x-handlebars-template'>
  <tr> <td colspan="4"> No topics </td> </tr>
</script>

<script id='tmpl-topics' type='text/x-handlebars-template'>
{{#topics}}
    <tr>
      <td> <a href="/topics/{{name}}" > {{name}} </a> </td>
      <td> {{partition_count}} </td>
      <td> {{replication_factor}} </td>
      <td> {{metrics.messages_in_per_sec}} </td>
      <td> {{metrics.bytes_in_per_sec}} </td>
      <td> {{metrics.bytes_out_per_sec}} </td>
    </tr>
  {{/topics}}
</script>

<div>
  <div>
    <h2> Users </h2>
    <table class=table>
      <thead>
        <tr>
          <th> Name </th>
        </tr>
      </thead>
      <tbody id="users-rows"> </tbody>
    </table>
  </div>
  <div>
    <h3> Add user </h2>
    <form id="add-user">
      <div class="form-group">
        <label for="name">Name</label>
        <input type="text" class="form-control" name="name" placeholder="Username">
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" class="form-control" name="password">
      </div>
      <button type="submit" class="btn btn-default">Create</button>
    </form>
  </div>
</div>

<script id='tmpl-no-users' type='text/x-handlebars-template'>
  <tr> <td colspan="4"> No users </td> </tr>
</script>

<script id='tmpl-users' type='text/x-handlebars-template'>
{{#users}}
    <tr>
      <td> <a href="/users/{{this}}" > {{ this }} </a> </td>
    </tr>
  {{/users}}
</script>

<script src='/js/jquery-3.1.1.min.js' type="text/javascript" ></script>
<script src='/js/handlebars.min.js' type="text/javascript" ></script>
<script type="text/javascript">

var renderTopics = function() {
  var $topics = $('#topic-rows');
  var topicsTmpl = Handlebars.compile($('#tmpl-topics').html());
  var noTopicsTmpl = Handlebars.compile($('#tmpl-no-topics').html());

  $.get("/api/topics", function(topics) {
    if (topics.length) {
      var l = topics.length;
      var result = [];
      topics.forEach(function(topic) {
        $.get("/api/topics/"+ topic, function(res) {
          result.push(res)
          if (result.length == l) {
            $topics.html(topicsTmpl({ topics: result }));
          }
        })
      })
    } else {
      $topics.html(noTopicsTmpl());
    }
  })
}

var renderBrokers = function() {
  var $brokers = $('#broker-rows');
  var brokersTmpl = Handlebars.compile($('#tmpl-brokers').html());
  var noBrokersTmpl = Handlebars.compile($('#tmpl-no-brokers').html());
  $.get("/api/brokers", function(brokers) {
    if (brokers.length) {
      var l = brokers.length;
      var result = [];
      brokers.forEach(function(broker) {
        $.get("/api/brokers/"+ broker, function(res) {
          result.push(res)
          if (result.length == l) {
            $brokers.html(brokersTmpl({ brokers: result }));
          }
        })
      })
    } else {
      $topics.html(noTopicsTmpl());
    }
  })
}

var renderUsers = function() {
  var $users = $('#users-rows');
  var usersTmpl = Handlebars.compile($('#tmpl-users').html());
  var noUsersTmpl = Handlebars.compile($('#tmpl-no-users').html());
  $.get("/api/users", function(users) {
    if (users.length) {
      $users.html(usersTmpl({ users: users }));
    } else {
      $users.html(noUsersTmpl());
    }
  })
}

$('#add-topic').submit(function(evt) {
  evt.preventDefault();
  $.post("/api/topics", $(this).serialize(), function(clb) {
    renderTopics();
  })
})

$('#add-user').submit(function(evt) {
  evt.preventDefault();
  $.post("/api/users", $(this).serialize(), function(clb) {
    renderUsers();
  })
})


renderTopics();
renderUsers();
renderBrokers();
</script>
