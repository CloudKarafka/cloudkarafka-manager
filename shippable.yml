branches:
  only:
    - master
    - stable

language: go

go:
  - 1.10.3

env:
  global:
    - secure: IeXN2EFxlDpCQGcxAKjumANOeH5/vVfyLu/LuHmL2mpuFucU0/5aNvr+Pabe1NywM25LbCnSxMCmPhsz9iXNbDJoVBuqbnWSdNdTepmZVwHPsZCvDbHG3NWfCNkwQoao/ti7Fd0tQ4LtGaTd2L50zn8HojdNs0WnDuv1iYVUcHP0lWEO8E/It5+35UbO7oexalGABWZzfMYhjtNv5QsHRz0OzK5zwQFfjpfTTcTHSgiOUzhNqoJgs/X97vkSmKnkBbGv0Z+fwfCBMwTqm0YUPbwOUdfZVRvh1tT3Jpm8jrVzClBT6A2puVyu43xZmfKrJPkH2UltF4BXeH+CZGgzxg==
      
build:
  ci:
    - apt-get update
    - apt-get install -y build-essential
    - curl -q -L https://github.com/edenhill/librdkafka/archive/v0.11.5.tar.gz | tar xzf -
    - pushd librdkafka-0.11.5
    - ./configure --prefix=/usr
    - make -j
    - make install
    - popd
    - mkdir -p /root/bin
    - curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
    - dep ensure -update
    - export GOOS=linux
    - export CGO_ENABLED=1
    - go build -ldflags "-X main.GitCommit=$COMMIT -X main.Version=0.0.2" -tags static -a -installsuffix cgo -o cloudkarafka-mgmt.linux
    - go test -v ./...
 
  on_success:
    - mkdir -p target
    - cp cloudkarafka-mgmt.linux target/cloudkarafka-mgmt.linux
    - cp -r static target/static
    - tar -czf cloudkarafka-mgmt.tar.gz target
    - aws s3 cp cloudkarafka-mgmt.tar.gz s3://cloudkafka-manager/staging/cloudkarafka-mgmt.tar.gz --region us-east-1

